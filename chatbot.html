<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hubby â€“ Chat assistant Club Med</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" integrity="sha512-sBvOB0fOkH1ZZ1xd6QbaO5jM90+hCbGyF/F7fs/3Gzdh0dX8GZFODdgNpTi27C/7fyqCkCmDYJLdnOjFk6tXrA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body class="chat-page">
    <div class="chat-app">
        <header class="chat-header">
            <button id="backButton" class="back-btn" type="button" aria-label="Back">
                â†
            </button>
            <div class="title-area">
                <h1 class="hubby-title">Hubby</h1>
                <div class="pop-chip" id="selectedPopIcon" aria-live="polite"></div>
            </div>
        </header>

        <section class="chat-interface">
            <div class="chat-window" id="chatWindow" role="log" aria-live="polite" aria-relevant="additions"></div>
            <div class="day-filter" id="dayFilter" role="group" aria-label="Filter by day">
                <!-- Buttons rendered by JavaScript -->
            </div>
            <div class="quick-actions" id="quickActions" aria-label="Quick actions">
                <!-- Buttons rendered by JavaScript -->
            </div>
            <div class="chat-input-area">
                <label class="visually-hidden" for="chatInput">Your message</label>
                <input type="text" id="chatInput" autocomplete="off" placeholder="Type your messageâ€¦">
                <button id="sendMessageBtn" type="button">Send</button>
            </div>
        </section>
    </div>

    <script>
        let hubbyChatData = null;

        async function loadHubbyChatData() {
            const dataUrl = 'https://github.com/UniversitedesTalents/testcode/raw/refs/heads/main/DATA-HUBBY-AD.xlsx';

            try {
                const response = await fetch(dataUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} â€“ ${response.statusText}`);
                }

                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const jsonData = {};

                workbook.SheetNames.forEach((sheetName) => {
                    const worksheet = workbook.Sheets[sheetName];
                    jsonData[sheetName] = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
                });

                hubbyChatData = jsonData;
                console.log('âœ… Hubby chatbot data loaded:', hubbyChatData);
                return hubbyChatData;
            } catch (error) {
                console.error('âŒ Failed to load Hubby data:', error);
                throw error;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const chatWindow = document.getElementById('chatWindow');
            const quickActionsContainer = document.getElementById('quickActions');
            const dayFilterContainer = document.getElementById('dayFilter');
            const chatInput = document.getElementById('chatInput');
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            const backButton = document.getElementById('backButton');
            const popChip = document.getElementById('selectedPopIcon');

            loadHubbyChatData().catch(() => {});

            const params = new URLSearchParams(window.location.search);
            const rawPopulation = params.get('population') || 'CDV';
            const requestedPopulation = decodeURIComponent(rawPopulation).toUpperCase();
            const allowedPopulations = ['CDV', 'LC', 'LKT', 'MKT', 'MKT+'];

            const state = {
                lang: 'en',
                day: null,
                population: allowedPopulations.includes(requestedPopulation) ? requestedPopulation : 'CDV',
                selectedAction: null
            };

            const dayOptions = [
                { key: 'arrival17', label: { en: 'Arrival 17' } },
                { key: 'monday', label: { en: 'Monday 18' } },
                { key: 'tuesday', label: { en: 'Tuesday 19' } },
                { key: 'wednesday', label: { en: 'Wednesday 20' } },
                { key: 'departure21', label: { en: 'Departure 21' } }
            ];

            const translations = {
                en: {
                    placeholder: 'Type your messageâ€¦',
                    send: 'Send',
                    typing: 'Hubby is typingâ€¦',
                    fallback: 'I donâ€™t have an answer for that yet ğŸ˜… Have a look at the quick buttons below.',
                    back: 'Back',
                    dayClear: 'All days',
                    quickActions: {
                        programme: 'Full program',
                        groupe: 'My group',
                        activites: 'Activities',
                        clubMedLive: 'Club Med Live',
                        infosPratiques: 'Practical info',
                        vivaEngage: 'Viva Engage'
                    },
                    initial: 'Hello! Iâ€™m here to guide you through the Academy Days. Pick a quick button or type your question.'
                }
            };

            const quickActionsByPopulation = {
                DEFAULT: ['programme', 'groupe', 'activites', 'clubMedLive', 'infosPratiques', 'vivaEngage'],
                CDV: ['programme', 'groupe', 'activites', 'clubMedLive', 'infosPratiques', 'vivaEngage'],
                LC: ['programme', 'groupe', 'activites', 'clubMedLive', 'infosPratiques', 'vivaEngage'],
                LKT: ['programme', 'groupe', 'activites', 'clubMedLive', 'infosPratiques', 'vivaEngage'],
                MKT: ['programme', 'groupe', 'activites', 'clubMedLive', 'infosPratiques', 'vivaEngage'],
                'MKT+': ['programme', 'groupe', 'activites', 'clubMedLive', 'infosPratiques', 'vivaEngage']
            };

            const responses = {
                DEFAULT: {
                    programme: {
                        fr: {
                            message: 'Voici le lien pour consulter le programme complet ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/programme', label: 'Programme gÃ©nÃ©ral' }
                        },
                        en: {
                            message: 'Hereâ€™s the link to view the full program ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/programme', label: 'Overall schedule' }
                        }
                    },
                    groupe: {
                        fr: {
                            message: 'DÃ©couvre ton groupe et les participants associÃ©s ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/groupes', label: 'AccÃ©der Ã  mon groupe' }
                        },
                        en: {
                            message: 'Check your group and fellow participants ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/groups', label: 'Open my group' }
                        }
                    },
                    activites: {
                        fr: {
                            message: 'Voici les expÃ©riences phares de la journÃ©e. Choisis ton mood et fonce !',
                            isHTML: true,
                            list: [
                                'ğŸ· <strong>Ã‰picurien</strong> : DÃ©gustation de vins, Atelier cuisine, Brunch gourmand.',
                                'ğŸ¨ <strong>CrÃ©atif</strong> : Poterie berbÃ¨re, Calligraphie arabe, Atelier hennÃ©.',
                                'ğŸƒâ€â™‚ï¸ <strong>Sportif</strong> : Tennis, Aqua fitness, RandonnÃ©e Atlas.',
                                'ğŸ§­ <strong>Curieux</strong> : Visite des souks, ConfÃ©rence berbÃ¨re, Jardin Majorelle.',
                                'ğŸ§˜ <strong>Bienveillant</strong> : Yoga sunrise, MÃ©ditation, Spa & hammam.'
                            ]
                        },
                        en: {
                            message: 'Here are the signature experiences for today. Pick your vibe and go!',
                            isHTML: true,
                            list: [
                                'ğŸ· <strong>Epicurean</strong>: Wine tasting, Cooking workshop, Gourmet brunch.',
                                'ğŸ¨ <strong>Creative</strong>: Berber pottery, Arabic calligraphy, Henna workshop.',
                                'ğŸƒâ€â™‚ï¸ <strong>Sporty</strong>: Tennis, Aqua fitness, Atlas hike.',
                                'ğŸ§­ <strong>Curious</strong>: Souk visit, Berber conference, Majorelle Garden.',
                                'ğŸ§˜ <strong>Caring</strong>: Sunrise yoga, Meditation, Spa & hammam.'
                            ]
                        }
                    },
                    clubMedLive: {
                        fr: {
                            message: 'Club Med Live te rÃ©serve un show diffÃ©rent chaque soir âœ¨',
                            days: {
                                arrival17: 'ğŸ›¬ Dimanche 17 : JournÃ©e dâ€™arrivÃ©e â€“ accueil dÃ©diÃ© au lobby principal.',
                                monday: 'ğŸ¶ Lundi 18 : Zavmusic Ã  21h â€“ set Ã©lectro innovant au thÃ©Ã¢tre Azur.',
                                tuesday: 'ğŸ· Mardi 19 : Sax Vibes Ã  20h30 â€“ soirÃ©e jazz moderne sur la terrasse Lagoon.',
                                wednesday: 'ğŸ¤ Mercredi 20 : ASMA & Mat Duval dÃ¨s 22h â€“ performance live au M Lounge.',
                                departure21: 'ğŸ‘‹ Jeudi 21 : JournÃ©e de dÃ©part â€“ navettes disponibles dÃ¨s 7h toutes les 30 min.'
                            }
                        },
                        en: {
                            message: 'Club Med Live brings a different vibe every night âœ¨',
                            days: {
                                arrival17: 'ğŸ›¬ Sunday 17th: Arrival day â€“ dedicated welcome desks in the main lobby.',
                                monday: 'ğŸ¶ Monday 18th: Zavmusic at 9 PM â€“ innovative electro set on the Azur stage.',
                                tuesday: 'ğŸ· Tuesday 19th: Sax Vibes at 8:30 PM â€“ modern jazz evening on the Lagoon terrace.',
                                wednesday: 'ğŸ¤ Wednesday 20th: ASMA & Mat Duval from 10 PM â€“ live performance at the M Lounge.',
                                departure21: 'ğŸ‘‹ Thursday 21st: Departure day â€“ shuttles available from 7 AM every 30 minutes.'
                            }
                        }
                    },
                    infosPratiques: {
                        fr: {
                            message: 'Retrouve ici les infos pratiques :',
                            isHTML: true,
                            list: [
                                'ğŸ•— <strong>Horaires navettes</strong> : toutes les 20 min depuis lâ€™entrÃ©e principale.',
                                'ğŸ“ <strong>Conciergerie Hubby</strong> : ouverte 8h-22h au lobby central.',
                                'ğŸ“± <strong>Assistance</strong> : WhatsApp +33 6 00 00 00 00.'
                            ]
                        },
                        en: {
                            message: 'Hereâ€™s your essential info:',
                            isHTML: true,
                            list: [
                                'ğŸ•— <strong>Shuttle schedule</strong>: every 20 minutes from the main gate.',
                                'ğŸ“ <strong>Hubby concierge</strong>: open 8 AM - 10 PM in the central lobby.',
                                'ğŸ“± <strong>Assistance</strong>: WhatsApp +33 6 00 00 00 00.'
                            ]
                        }
                    },
                    vivaEngage: {
                        fr: {
                            message: 'DÃ©couvre nos communautÃ©s sur Viva Engage ğŸ‘‡',
                            isHTML: true,
                            links: [
                                { label: 'AI Learning Club', url: 'https://engage.cloud.microsoft/main/groups/eyJfdHlwZSI6Ikdyb3VwIiwiaWQiOiIyMjcxNDczNDE4MjQifQ/all' },
                                { label: 'Forever Young', url: 'https://engage.cloud.microsoft/main/groups/eyJfdHlwZSI6Ikdyb3VwIiwiaWQiOiIyMjc0NjE0NjQwNjQifQ/new' },
                                { label: 'Club Med News & Events', url: 'https://engage.cloud.microsoft/main/groups/eyJfdHlwZSI6Ikdyb3VwIiwiaWQiOiIyMjYyMDY4OTIwMzIifQ/new' }
                            ]
                        },
                        en: {
                            message: 'Explore our Viva Engage communities ğŸ‘‡',
                            isHTML: true,
                            links: [
                                { label: 'AI Learning Club', url: 'https://engage.cloud.microsoft/main/groups/eyJfdHlwZSI6Ikdyb3VwIiwiaWQiOiIyMjcxNDczNDE4MjQifQ/all' },
                                { label: 'Forever Young', url: 'https://engage.cloud.microsoft/main/groups/eyJfdHlwZSI6Ikdyb3VwIiwiaWQiOiIyMjc0NjE0NjQwNjQifQ/new' },
                                { label: 'Club Med News & Events', url: 'https://engage.cloud.microsoft/main/groups/eyJfdHlwZSI6Ikdyb3VwIiwiaWQiOiIyMjYyMDY4OTIwMzIifQ/new' }
                            ]
                        }
                    }
                },
                CDV: {
                    programme: {
                        fr: {
                            message: 'Ton programme CDV met lâ€™accent sur les temps forts opÃ©rationnels. Retrouve-le ici ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/programme-cdv', label: 'Programme CDV' }
                        },
                        en: {
                            message: 'Your CDV schedule highlights the key operational moments. Access it here ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/program-cdv', label: 'CDV program' }
                        }
                    },
                    groupe: {
                        fr: {
                            message: 'Le mapping de ton village et des Ã©quipes associÃ©es est prÃªt ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/groupes-cdv', label: 'Voir mon rÃ©seau CDV' }
                        },
                        en: {
                            message: 'Your village mapping and partner teams are ready ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/groups-cdv', label: 'View my CDV network' }
                        }
                    },
                    activites: {
                        fr: {
                            message: 'Ta sÃ©lection CDV met lâ€™accent sur le partage terrain. Voici les expÃ©riences clÃ©s :'
                        },
                        en: {
                            message: 'Your CDV selection focuses on field sharing. Here are todayâ€™s highlights:'
                        }
                    },
                    infosPratiques: {
                        fr: {
                            message: 'Tes points clÃ©s du jour :',
                            isHTML: true,
                            list: [
                                'ğŸ§­ <strong>Brief opÃ©rationnel</strong> : 8h salle Latitude.',
                                'ğŸš <strong>Visite terrain</strong> : dÃ©part 15h depuis le lobby.',
                                'ğŸ¤ <strong>Desk support</strong> : assistance villages 8h-20h.'
                            ]
                        },
                        en: {
                            message: 'Todayâ€™s key checkpoints:',
                            isHTML: true,
                            list: [
                                'ğŸ§­ <strong>Operations briefing</strong>: 8 AM in Latitude room.',
                                'ğŸš <strong>Field visit</strong>: 3 PM departure from the lobby.',
                                'ğŸ¤ <strong>Support desk</strong>: village assistance from 8 AM to 8 PM.'
                            ]
                        }
                    }
                },
                LC: {
                    programme: {
                        fr: {
                            message: 'Ton parcours LC est optimisÃ© autour des rencontres clients. Consulter le planning ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/programme-lc', label: 'Programme LC' }
                        },
                        en: {
                            message: 'Your LC path is tailored to client sessions. Check the schedule ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/program-lc', label: 'LC program' }
                        }
                    },
                    groupe: {
                        fr: {
                            message: 'Voici la composition de ton portefeuille clients pour la journÃ©e ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/groupes-lc', label: 'Voir mes clients' }
                        },
                        en: {
                            message: 'Hereâ€™s todayâ€™s client portfolio for your group ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/groups-lc', label: 'View my clients' }
                        }
                    },
                    activites: {
                        fr: {
                            message: 'Pour tes clients, privilÃ©gie ces moments expÃ©rientiels :'
                        },
                        en: {
                            message: 'For your clients, spotlight these experiential moments:'
                        }
                    },
                    infosPratiques: {
                        fr: {
                            message: 'Ã€ ne pas manquer :',
                            isHTML: true,
                            list: [
                                'ğŸ“ <strong>Accueil clients</strong> : amphithÃ©Ã¢tre Azur dÃ¨s 9h.',
                                'ğŸ§³ <strong>Logistique marketing</strong> : corner Riviera 14h-18h.',
                                'ğŸ’¬ <strong>Coaching pitch</strong> : sessions flash Ã  16h.'
                            ]
                        },
                        en: {
                            message: 'Donâ€™t miss:',
                            isHTML: true,
                            list: [
                                'ğŸ“ <strong>Client welcome</strong>: Azur theater from 9 AM.',
                                'ğŸ§³ <strong>Marketing logistics</strong>: Riviera corner 2 PM - 6 PM.',
                                'ğŸ’¬ <strong>Pitch coaching</strong>: flash sessions at 4 PM.'
                            ]
                        }
                    }
                },
                LKT: {
                    programme: {
                        fr: {
                            message: 'Les masterclasses LKT et les ateliers best practices sont ici ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/programme-lkt', label: 'Programme LKT' }
                        },
                        en: {
                            message: 'All LKT masterclasses and best-practice labs are available here ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/program-lkt', label: 'LKT program' }
                        }
                    },
                    groupe: {
                        fr: {
                            message: 'Retrouve ton cercle dâ€™apprentissage et les speakers associÃ©s ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/groupes-lkt', label: 'Mon cercle LKT' }
                        },
                        en: {
                            message: 'Find your learning circle and the related speakers ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/groups-lkt', label: 'My LKT circle' }
                        }
                    },
                    activites: {
                        fr: {
                            message: 'Pour alimenter tes partages de bonnes pratiques, explore ces ateliers signatures :'
                        },
                        en: {
                            message: 'Fuel your best-practice exchanges with these signature workshops:'
                        }
                    },
                    infosPratiques: {
                        fr: {
                            message: 'Tes repÃ¨res pour la journÃ©e :',
                            isHTML: true,
                            list: [
                                'ğŸ“ <strong>Atelier opening</strong> : 10h salle Compass.',
                                'ğŸ’¡ <strong>Masterclass digitale</strong> : Horizon B Ã  14h.',
                                'ğŸ¹ <strong>Afterwork partage</strong> : rooftop Horizon 18h30.'
                            ]
                        },
                        en: {
                            message: 'Todayâ€™s landmarks:',
                            isHTML: true,
                            list: [
                                'ğŸ“ <strong>Workshop opening</strong>: 10 AM in Compass room.',
                                'ğŸ’¡ <strong>Digital masterclass</strong>: Horizon B at 2 PM.',
                                'ğŸ¹ <strong>Sharing afterwork</strong>: Horizon rooftop 6:30 PM.'
                            ]
                        }
                    }
                },
                MKT: {
                    programme: {
                        fr: {
                            message: 'Ton agenda communication & influence se trouve ici ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/programme-mkt', label: 'Programme MKT' }
                        },
                        en: {
                            message: 'Your communication & influence schedule lives here ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/program-mkt', label: 'MKT program' }
                        }
                    },
                    groupe: {
                        fr: {
                            message: 'Retrouve ton squad marketing et les influenceurs associÃ©s ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/groupes-mkt', label: 'Mon squad MKT' }
                        },
                        en: {
                            message: 'Access your marketing squad and linked influencers ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/groups-mkt', label: 'My MKT squad' }
                        }
                    },
                    activites: {
                        fr: {
                            message: 'Voici les expÃ©riences idÃ©ales pour nourrir ta stratÃ©gie de contenu :'
                        },
                        en: {
                            message: 'These experiences are perfect to feed your content strategy:'
                        }
                    },
                    infosPratiques: {
                        fr: {
                            message: 'Highlights du jour :',
                            isHTML: true,
                            list: [
                                'ğŸ“¸ <strong>Studio photo</strong> : ouvert 14h-17h.',
                                'ğŸ§  <strong>Workshop storytelling</strong> : 11h salle Riviera.',
                                'ğŸ¤³ <strong>Social media lab</strong> : coaching express 16h.'
                            ]
                        },
                        en: {
                            message: 'Todayâ€™s highlights:',
                            isHTML: true,
                            list: [
                                'ğŸ“¸ <strong>Photo studio</strong>: open 2 PM - 5 PM.',
                                'ğŸ§  <strong>Storytelling workshop</strong>: 11 AM in Riviera room.',
                                'ğŸ¤³ <strong>Social media lab</strong>: express coaching at 4 PM.'
                            ]
                        }
                    }
                },
                'MKT+': {
                    programme: {
                        fr: {
                            message: 'Ton agenda exclusif MKT+ est disponible ici ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/programme-mktplus', label: 'Programme MKT+' }
                        },
                        en: {
                            message: 'Your exclusive MKT+ agenda is ready here ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/program-mktplus', label: 'MKT+ program' }
                        }
                    },
                    groupe: {
                        fr: {
                            message: 'Voici les accÃ¨s VIP et ton cercle premium ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/groupes-mktplus', label: 'Cercle MKT+' }
                        },
                        en: {
                            message: 'Here are your VIP accesses and premium circle ğŸ‘‡',
                            link: { url: 'https://hubby.clubmed/groups-mktplus', label: 'MKT+ circle' }
                        }
                    },
                    activites: {
                        fr: {
                            message: 'Tes accÃ¨s privilÃ©giÃ©s tâ€™ouvrent ces expÃ©riences exclusives :'
                        },
                        en: {
                            message: 'Your privileged access unlocks these exclusive experiences:'
                        }
                    },
                    infosPratiques: {
                        fr: {
                            message: 'Pour profiter Ã  fond :',
                            isHTML: true,
                            list: [
                                'ğŸ¥‚ <strong>Salon privÃ© Lagoon</strong> : ouvert dÃ¨s 9h.',
                                'ğŸ§‘â€ğŸ’¼ <strong>Conciergerie dÃ©diÃ©e</strong> : hotline MKT+ 8h-22h.',
                                'ğŸ½ï¸ <strong>DÃ®ner signature</strong> : 20h30 avec le Chef.'
                            ]
                        },
                        en: {
                            message: 'Make the most of it:',
                            isHTML: true,
                            list: [
                                'ğŸ¥‚ <strong>Lagoon private lounge</strong>: open from 9 AM.',
                                'ğŸ§‘â€ğŸ’¼ <strong>Dedicated concierge</strong>: MKT+ hotline 8 AM - 10 PM.',
                                'ğŸ½ï¸ <strong>Signature dinner</strong>: 8:30 PM with the Chef.'
                            ]
                        }
                    }
                }
            };

            const keywordMap = {
                programme: ['programme', 'program', 'schedule', 'agenda'],
                groupe: ['groupe', 'group', 'squad', 'team'],
                activites: ['activit', 'activity', 'atelier', 'workshop'],
                clubMedLive: ['live', 'concert', 'music', 'show'],
                infosPratiques: ['info', 'pratique', 'practical', 'shuttle', 'horaire', 'schedule'],
                vivaEngage: ['viva', 'engage', 'community', 'communaut']
            };

            popChip.textContent = state.population;

            document.documentElement.lang = state.lang;

            chatInput.placeholder = translations[state.lang].placeholder;
            sendMessageBtn.textContent = translations[state.lang].send;
            backButton.setAttribute('aria-label', translations[state.lang].back);

            renderDayFilter();
            renderQuickActions();
            appendHubbyMessage(translations[state.lang].initial);

            backButton.addEventListener('click', () => {
                window.location.href = 'index.html';
            });

            dayFilterContainer.addEventListener('click', (event) => {
                const button = event.target.closest('button[data-day]');
                if (!button) {
                    return;
                }
                const selectedDay = button.dataset.day || null;
                if (selectedDay === state.day) {
                    return;
                }
                state.day = selectedDay;
                renderDayFilter();
            });

            quickActionsContainer.addEventListener('click', (event) => {
                const button = event.target.closest('button[data-action]');
                if (!button) {
                    return;
                }
                const actionKey = button.dataset.action;
                const label = button.textContent.trim();
                state.selectedAction = actionKey;
                updateQuickActionSelection();
                handleUserMessage(label, actionKey);
            });

            sendMessageBtn.addEventListener('click', submitMessage);
            chatInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    submitMessage();
                }
            });

            function submitMessage() {
                const message = chatInput.value.trim();
                if (!message) {
                    return;
                }
                chatInput.value = '';
                chatInput.focus();
                handleUserMessage(message);
            }

            function handleUserMessage(message, forcedAction = null) {
                appendUserMessage(message);
                const actionKey = forcedAction || detectAction(message);
                if (actionKey) {
                    respondWithAction(actionKey);
                } else {
                    respondWithFallback();
                }
            }

            function normalizeText(text) {
                return text
                    .normalize('NFD')
                    .replace(/\p{Diacritic}/gu, '')
                    .toLowerCase();
            }

            function detectAction(message) {
                const normalized = normalizeText(message);
                for (const [action, keywords] of Object.entries(keywordMap)) {
                    if (keywords.some((keyword) => normalized.includes(keyword))) {
                        return action;
                    }
                }
                return null;
            }

            function respondWithAction(actionKey) {
                const response = getResponseContent(actionKey);
                if (!response) {
                    respondWithFallback();
                    return;
                }
                showTypingIndicator(() => {
                    appendHubbyMessage(response.message, response.isHTML);
                });
            }

            function respondWithFallback() {
                const fallback = translations[state.lang].fallback;
                showTypingIndicator(() => {
                    appendHubbyMessage(fallback);
                });
            }

            function getResponseContent(actionKey) {
                const baseEntry = responses.DEFAULT?.[actionKey];
                const populationEntry = responses[state.population]?.[actionKey];
                const entry = mergeEntries(baseEntry, populationEntry);
                if (!entry) {
                    return null;
                }
                const langContent = cloneContent(entry[state.lang]);
                if (!langContent) {
                    return null;
                }

                let message = '';
                let isHTML = Boolean(langContent?.isHTML);

                if (langContent?.days) {
                    const dayMessage = state.day ? langContent.days[state.day] : null;
                    message = dayMessage || langContent.days.default || '';
                }

                if (!message && typeof langContent === 'string') {
                    message = langContent;
                }

                if (!message && langContent?.message) {
                    message = langContent.message;
                }

                if (Array.isArray(langContent?.list) && langContent.list.length) {
                    const listMarkup = langContent.list.map((item) => `<li>${item}</li>`).join('');
                    const wrapper = `<ul class="message-list">${listMarkup}</ul>`;
                    message = message ? `${message}<br>${wrapper}` : wrapper;
                    isHTML = true;
                }

                if (langContent?.link) {
                    const link = langContent.link;
                    const linkMarkup = `<a href="${link.url}" target="_blank" rel="noopener noreferrer">${link.label || link.url}</a>`;
                    message = message ? `${message}<br>${linkMarkup}` : linkMarkup;
                    isHTML = true;
                }

                if (Array.isArray(langContent?.links) && langContent.links.length) {
                    const linksMarkup = langContent.links
                        .map((link) => `<a href="${link.url}" target="_blank" rel="noopener noreferrer">${link.label || link.url}</a>`)
                        .join('<br>');
                    message = message ? `${message}<br>${linksMarkup}` : linksMarkup;
                    isHTML = true;
                }

                if (!message) {
                    return null;
                }

                return { message, isHTML };
            }

            function mergeEntries(baseEntry, populationEntry) {
                if (!baseEntry && !populationEntry) {
                    return null;
                }
                if (!baseEntry) {
                    return cloneContent(populationEntry);
                }
                if (!populationEntry) {
                    return cloneContent(baseEntry);
                }
                const merged = {};
                for (const lang of ['en']) {
                    if (populationEntry[lang] !== undefined) {
                        merged[lang] = mergeLanguageContent(baseEntry[lang], populationEntry[lang]);
                    } else if (baseEntry[lang] !== undefined) {
                        merged[lang] = cloneContent(baseEntry[lang]);
                    }
                }
                return merged;
            }

            function mergeLanguageContent(baseLang, overrideLang) {
                if (overrideLang === undefined || overrideLang === null) {
                    return cloneContent(baseLang);
                }
                if (typeof baseLang === 'string' && typeof overrideLang === 'string') {
                    return overrideLang;
                }
                if (typeof overrideLang === 'string') {
                    return overrideLang;
                }
                if (typeof baseLang === 'string') {
                    return cloneContent(overrideLang);
                }
                const merged = { ...cloneContent(baseLang), ...cloneContent(overrideLang) };
                if (baseLang?.list && overrideLang?.list) {
                    merged.list = overrideLang.list;
                }
                if (baseLang?.links && overrideLang?.links) {
                    merged.links = overrideLang.links;
                }
                if (baseLang?.days && overrideLang?.days) {
                    merged.days = { ...baseLang.days, ...overrideLang.days };
                }
                return merged;
            }

            function cloneContent(content) {
                if (content === undefined || content === null) {
                    return content;
                }
                if (typeof content === 'string') {
                    return content;
                }
                return JSON.parse(JSON.stringify(content));
            }

            function appendUserMessage(text) {
                appendMessage('user', text, false);
            }

            function appendHubbyMessage(text, isHTML = false) {
                appendMessage('hubby', text, isHTML);
            }

            function appendMessage(author, text, isHTML) {
                const bubble = document.createElement('div');
                bubble.className = `message ${author === 'hubby' ? 'message--hubby' : 'message--user'}`;
                const paragraph = document.createElement('div');
                paragraph.className = 'message-content';
                if (isHTML) {
                    paragraph.innerHTML = text;
                } else {
                    paragraph.textContent = text;
                }
                bubble.appendChild(paragraph);
                chatWindow.appendChild(bubble);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            function showTypingIndicator(callback) {
                const indicator = document.createElement('div');
                indicator.className = 'message message--hubby message--typing';
                indicator.setAttribute('aria-live', 'assertive');
                indicator.innerHTML = `<div class="typing-indicator">${translations[state.lang].typing}</div>`;
                chatWindow.appendChild(indicator);
                chatWindow.scrollTop = chatWindow.scrollHeight;

                window.setTimeout(() => {
                    indicator.remove();
                    callback();
                }, 900);
            }

            function renderQuickActions() {
                quickActionsContainer.innerHTML = '';
                const keys = quickActionsByPopulation[state.population] || quickActionsByPopulation.DEFAULT;
                keys.forEach((key) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.dataset.action = key;
                    button.className = 'quick-action-btn';
                    button.textContent = translations[state.lang].quickActions[key] || key;
                    quickActionsContainer.appendChild(button);
                });
                updateQuickActionSelection();
            }

            function updateQuickActionSelection() {
                const buttons = quickActionsContainer.querySelectorAll('.quick-action-btn');
                buttons.forEach((button) => {
                    const isActive = button.dataset.action === state.selectedAction;
                    button.classList.toggle('is-active', isActive);
                });
            }

            function renderDayFilter() {
                dayFilterContainer.innerHTML = '';

                const clearButton = document.createElement('button');
                clearButton.type = 'button';
                clearButton.className = `day-pill${state.day === null ? ' active-date' : ''}`;
                clearButton.dataset.day = '';
                clearButton.textContent = translations[state.lang].dayClear;
                dayFilterContainer.appendChild(clearButton);

                dayOptions.forEach((option) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.dataset.day = option.key;
                    button.className = `day-pill${state.day === option.key ? ' active-date' : ''}`;
                    button.textContent = option.label[state.lang];
                    dayFilterContainer.appendChild(button);
                });
            }
        });
    </script>
</body>
</html>
