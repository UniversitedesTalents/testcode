<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hubby ‚Äì Chat assistant Club Med</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="chat-page">
    <div class="chat-app">
        <header class="chat-header">
            <button id="backButton" class="back-btn" type="button" aria-label="Retour">
                ‚Üê
            </button>
            <div class="title-area">
                <h1 class="hubby-title">Hubby</h1>
                <div class="pop-chip" id="selectedPopIcon" aria-live="polite"></div>
            </div>
            <div class="lang-toggle" role="group" aria-label="Choisir la langue">
                <button id="langFrChat" type="button" data-lang="fr" class="lang-btn is-active">FR</button>
                <button id="langEnChat" type="button" data-lang="en" class="lang-btn">EN</button>
            </div>
        </header>

        <section class="chat-interface">
            <div class="chat-window" id="chatWindow" role="log" aria-live="polite" aria-relevant="additions"></div>
            <div class="day-filter" id="dayFilter" role="group" aria-label="Filtrer par jour">
                <!-- Buttons rendered by JavaScript -->
            </div>
            <div class="quick-actions" id="quickActions" aria-label="Actions rapides">
                <!-- Buttons rendered by JavaScript -->
            </div>
            <div class="chat-input-area">
                <label class="visually-hidden" for="chatInput">Votre message</label>
                <input type="text" id="chatInput" autocomplete="off" placeholder="√âcrivez votre message...">
                <button id="sendMessageBtn" type="button">Envoyer</button>
            </div>
        </section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chatWindow = document.getElementById('chatWindow');
            const quickActionsContainer = document.getElementById('quickActions');
            const dayFilterContainer = document.getElementById('dayFilter');
            const chatInput = document.getElementById('chatInput');
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            const backButton = document.getElementById('backButton');
            const langButtons = Array.from(document.querySelectorAll('.lang-btn'));
            const popChip = document.getElementById('selectedPopIcon');

            const params = new URLSearchParams(window.location.search);
            const rawPopulation = params.get('population') || 'CDV';
            const requestedPopulation = decodeURIComponent(rawPopulation).toUpperCase();
            const allowedPopulations = ['CDV', 'LC', 'LKT', 'MKT', 'MKT+'];

            const state = {
                lang: 'fr',
                day: null,
                population: allowedPopulations.includes(requestedPopulation) ? requestedPopulation : 'CDV'
            };

            const dayOptions = [
                { key: 'monday', label: { fr: 'Lundi 18', en: 'Monday 18' } },
                { key: 'tuesday', label: { fr: 'Mardi 19', en: 'Tuesday 19' } },
                { key: 'wednesday', label: { fr: 'Mercredi 20', en: 'Wednesday 20' } },
                { key: 'thursday', label: { fr: 'Jeudi 21', en: 'Thursday 21' } }
            ];

            const translations = {
                fr: {
                    placeholder: '√âcrivez votre message...',
                    send: 'Envoyer',
                    typing: 'Hubby tape‚Ä¶',
                    fallback: 'Je n‚Äôai pas encore la r√©ponse √† cette question üòÖ Tu peux jeter un ≈ìil aux boutons rapides ci-dessous.',
                    back: 'Retour',
                    dayClear: 'Tous les jours',
                    quickActions: {
                        programme: 'Programme complet',
                        groupe: 'Mon groupe',
                        activites: 'Activit√©s',
                        clubMedLive: 'Club Med Live',
                        infosPratiques: 'Infos pratiques',
                        vivaEngage: 'Viva Engage'
                    },
                    initial: 'Bonjour ! Je suis l√† pour te guider pendant les Academy Days. Choisis un bouton rapide ou √©cris ta question.'
                },
                en: {
                    placeholder: 'Type your message‚Ä¶',
                    send: 'Send',
                    typing: 'Hubby is typing‚Ä¶',
                    fallback: 'I don‚Äôt have an answer for that yet üòÖ Have a look at the quick buttons below.',
                    back: 'Back',
                    dayClear: 'All days',
                    quickActions: {
                        programme: 'Full program',
                        groupe: 'My group',
                        activites: 'Activities',
                        clubMedLive: 'Club Med Live',
                        infosPratiques: 'Practical info',
                        vivaEngage: 'Viva Engage'
                    },
                    initial: 'Hello! I‚Äôm here to guide you through the Academy Days. Pick a quick button or type your question.'
                }
            };

            const quickActionsByPopulation = {
                DEFAULT: ['programme', 'groupe', 'activites', 'clubMedLive', 'infosPratiques', 'vivaEngage'],
                CDV: ['programme', 'groupe', 'activites', 'clubMedLive', 'infosPratiques', 'vivaEngage'],
                LC: ['programme', 'groupe', 'activites', 'clubMedLive', 'infosPratiques', 'vivaEngage'],
                LKT: ['programme', 'groupe', 'activites', 'clubMedLive', 'infosPratiques', 'vivaEngage'],
                MKT: ['programme', 'groupe', 'activites', 'clubMedLive', 'infosPratiques', 'vivaEngage'],
                'MKT+': ['programme', 'groupe', 'activites', 'clubMedLive', 'infosPratiques', 'vivaEngage']
            };

            const responses = {
                DEFAULT: {
                    programme: {
                        fr: {
                            message: 'Voici le lien pour consulter le programme complet üëá',
                            link: { url: 'https://hubby.clubmed/programme', label: 'Programme g√©n√©ral' }
                        },
                        en: {
                            message: 'Here‚Äôs the link to view the full program üëá',
                            link: { url: 'https://hubby.clubmed/programme', label: 'Overall schedule' }
                        }
                    },
                    groupe: {
                        fr: {
                            message: 'D√©couvre ton groupe et les participants associ√©s üëá',
                            link: { url: 'https://hubby.clubmed/groupes', label: 'Acc√©der √† mon groupe' }
                        },
                        en: {
                            message: 'Check your group and fellow participants üëá',
                            link: { url: 'https://hubby.clubmed/groups', label: 'Open my group' }
                        }
                    },
                    activites: {
                        fr: {
                            message: 'Voici les exp√©riences phares de la journ√©e. Choisis ton mood et fonce !',
                            isHTML: true,
                            list: [
                                'üç∑ <strong>√âpicurien</strong> : D√©gustation de vins, Atelier cuisine, Brunch gourmand.',
                                'üé® <strong>Cr√©atif</strong> : Poterie berb√®re, Calligraphie arabe, Atelier henn√©.',
                                'üèÉ‚Äç‚ôÇÔ∏è <strong>Sportif</strong> : Tennis, Aqua fitness, Randonn√©e Atlas.',
                                'üß≠ <strong>Curieux</strong> : Visite des souks, Conf√©rence berb√®re, Jardin Majorelle.',
                                'üßò <strong>Bienveillant</strong> : Yoga sunrise, M√©ditation, Spa & hammam.'
                            ]
                        },
                        en: {
                            message: 'Here are the signature experiences for today. Pick your vibe and go!',
                            isHTML: true,
                            list: [
                                'üç∑ <strong>Epicurean</strong>: Wine tasting, Cooking workshop, Gourmet brunch.',
                                'üé® <strong>Creative</strong>: Berber pottery, Arabic calligraphy, Henna workshop.',
                                'üèÉ‚Äç‚ôÇÔ∏è <strong>Sporty</strong>: Tennis, Aqua fitness, Atlas hike.',
                                'üß≠ <strong>Curious</strong>: Souk visit, Berber conference, Majorelle Garden.',
                                'üßò <strong>Caring</strong>: Sunrise yoga, Meditation, Spa & hammam.'
                            ]
                        }
                    },
                    clubMedLive: {
                        fr: {
                            message: 'Club Med Live te r√©serve un show diff√©rent chaque soir ‚ú®',
                            days: {
                                monday: 'üé∂ Lundi 18 : Zavmusic √† 21h ‚Äì set √©lectro innovant au th√©√¢tre Azur.',
                                tuesday: 'üé∑ Mardi 19 : Sax Vibes √† 20h30 ‚Äì soir√©e jazz moderne sur la terrasse Lagoon.',
                                wednesday: 'üé§ Mercredi 20 : ASMA & Mat Duval d√®s 22h ‚Äì performance live au M Lounge.',
                                thursday: 'ü™ò Jeudi 21 : Sunset Jam √† 19h ‚Äì fusion world au rooftop Horizon.'
                            }
                        },
                        en: {
                            message: 'Club Med Live brings a different vibe every night ‚ú®',
                            days: {
                                monday: 'üé∂ Monday 18th: Zavmusic at 9 PM ‚Äì innovative electro set on the Azur stage.',
                                tuesday: 'üé∑ Tuesday 19th: Sax Vibes at 8:30 PM ‚Äì modern jazz evening on the Lagoon terrace.',
                                wednesday: 'üé§ Wednesday 20th: ASMA & Mat Duval from 10 PM ‚Äì live performance at the M Lounge.',
                                thursday: 'ü™ò Thursday 21st: Sunset Jam at 7 PM ‚Äì world fusion on the Horizon rooftop.'
                            }
                        }
                    },
                    infosPratiques: {
                        fr: {
                            message: 'Retrouve ici les infos pratiques :',
                            isHTML: true,
                            list: [
                                'üïó <strong>Horaires navettes</strong> : toutes les 20 min depuis l‚Äôentr√©e principale.',
                                'üìç <strong>Conciergerie Hubby</strong> : ouverte 8h-22h au lobby central.',
                                'üì± <strong>Assistance</strong> : WhatsApp +33 6 00 00 00 00.'
                            ]
                        },
                        en: {
                            message: 'Here‚Äôs your essential info:',
                            isHTML: true,
                            list: [
                                'üïó <strong>Shuttle schedule</strong>: every 20 minutes from the main gate.',
                                'üìç <strong>Hubby concierge</strong>: open 8 AM - 10 PM in the central lobby.',
                                'üì± <strong>Assistance</strong>: WhatsApp +33 6 00 00 00 00.'
                            ]
                        }
                    },
                    vivaEngage: {
                        fr: {
                            message: 'D√©couvre nos communaut√©s sur Viva Engage üëá',
                            isHTML: true,
                            links: [
                                { label: 'AI Learning Club', url: 'https://engage.cloud.microsoft/main/groups/eyJfdHlwZSI6Ikdyb3VwIiwiaWQiOiIyMjcxNDczNDE4MjQifQ/all' },
                                { label: 'Forever Young', url: 'https://engage.cloud.microsoft/main/groups/eyJfdHlwZSI6Ikdyb3VwIiwiaWQiOiIyMjc0NjE0NjQwNjQifQ/new' },
                                { label: 'Club Med News & Events', url: 'https://engage.cloud.microsoft/main/groups/eyJfdHlwZSI6Ikdyb3VwIiwiaWQiOiIyMjYyMDY4OTIwMzIifQ/new' }
                            ]
                        },
                        en: {
                            message: 'Explore our Viva Engage communities üëá',
                            isHTML: true,
                            links: [
                                { label: 'AI Learning Club', url: 'https://engage.cloud.microsoft/main/groups/eyJfdHlwZSI6Ikdyb3VwIiwiaWQiOiIyMjcxNDczNDE4MjQifQ/all' },
                                { label: 'Forever Young', url: 'https://engage.cloud.microsoft/main/groups/eyJfdHlwZSI6Ikdyb3VwIiwiaWQiOiIyMjc0NjE0NjQwNjQifQ/new' },
                                { label: 'Club Med News & Events', url: 'https://engage.cloud.microsoft/main/groups/eyJfdHlwZSI6Ikdyb3VwIiwiaWQiOiIyMjYyMDY4OTIwMzIifQ/new' }
                            ]
                        }
                    }
                },
                CDV: {
                    programme: {
                        fr: {
                            message: 'Ton programme CDV met l‚Äôaccent sur les temps forts op√©rationnels. Retrouve-le ici üëá',
                            link: { url: 'https://hubby.clubmed/programme-cdv', label: 'Programme CDV' }
                        },
                        en: {
                            message: 'Your CDV schedule highlights the key operational moments. Access it here üëá',
                            link: { url: 'https://hubby.clubmed/program-cdv', label: 'CDV program' }
                        }
                    },
                    groupe: {
                        fr: {
                            message: 'Le mapping de ton village et des √©quipes associ√©es est pr√™t üëá',
                            link: { url: 'https://hubby.clubmed/groupes-cdv', label: 'Voir mon r√©seau CDV' }
                        },
                        en: {
                            message: 'Your village mapping and partner teams are ready üëá',
                            link: { url: 'https://hubby.clubmed/groups-cdv', label: 'View my CDV network' }
                        }
                    },
                    activites: {
                        fr: {
                            message: 'Ta s√©lection CDV met l‚Äôaccent sur le partage terrain. Voici les exp√©riences cl√©s :'
                        },
                        en: {
                            message: 'Your CDV selection focuses on field sharing. Here are today‚Äôs highlights:'
                        }
                    },
                    infosPratiques: {
                        fr: {
                            message: 'Tes points cl√©s du jour :',
                            isHTML: true,
                            list: [
                                'üß≠ <strong>Brief op√©rationnel</strong> : 8h salle Latitude.',
                                'üöê <strong>Visite terrain</strong> : d√©part 15h depuis le lobby.',
                                'ü§ù <strong>Desk support</strong> : assistance villages 8h-20h.'
                            ]
                        },
                        en: {
                            message: 'Today‚Äôs key checkpoints:',
                            isHTML: true,
                            list: [
                                'üß≠ <strong>Operations briefing</strong>: 8 AM in Latitude room.',
                                'üöê <strong>Field visit</strong>: 3 PM departure from the lobby.',
                                'ü§ù <strong>Support desk</strong>: village assistance from 8 AM to 8 PM.'
                            ]
                        }
                    }
                },
                LC: {
                    programme: {
                        fr: {
                            message: 'Ton parcours LC est optimis√© autour des rencontres clients. Consulter le planning üëá',
                            link: { url: 'https://hubby.clubmed/programme-lc', label: 'Programme LC' }
                        },
                        en: {
                            message: 'Your LC path is tailored to client sessions. Check the schedule üëá',
                            link: { url: 'https://hubby.clubmed/program-lc', label: 'LC program' }
                        }
                    },
                    groupe: {
                        fr: {
                            message: 'Voici la composition de ton portefeuille clients pour la journ√©e üëá',
                            link: { url: 'https://hubby.clubmed/groupes-lc', label: 'Voir mes clients' }
                        },
                        en: {
                            message: 'Here‚Äôs today‚Äôs client portfolio for your group üëá',
                            link: { url: 'https://hubby.clubmed/groups-lc', label: 'View my clients' }
                        }
                    },
                    activites: {
                        fr: {
                            message: 'Pour tes clients, privil√©gie ces moments exp√©rientiels :'
                        },
                        en: {
                            message: 'For your clients, spotlight these experiential moments:'
                        }
                    },
                    infosPratiques: {
                        fr: {
                            message: '√Ä ne pas manquer :',
                            isHTML: true,
                            list: [
                                'üìç <strong>Accueil clients</strong> : amphith√©√¢tre Azur d√®s 9h.',
                                'üß≥ <strong>Logistique marketing</strong> : corner Riviera 14h-18h.',
                                'üí¨ <strong>Coaching pitch</strong> : sessions flash √† 16h.'
                            ]
                        },
                        en: {
                            message: 'Don‚Äôt miss:',
                            isHTML: true,
                            list: [
                                'üìç <strong>Client welcome</strong>: Azur theater from 9 AM.',
                                'üß≥ <strong>Marketing logistics</strong>: Riviera corner 2 PM - 6 PM.',
                                'üí¨ <strong>Pitch coaching</strong>: flash sessions at 4 PM.'
                            ]
                        }
                    }
                },
                LKT: {
                    programme: {
                        fr: {
                            message: 'Les masterclasses LKT et les ateliers best practices sont ici üëá',
                            link: { url: 'https://hubby.clubmed/programme-lkt', label: 'Programme LKT' }
                        },
                        en: {
                            message: 'All LKT masterclasses and best-practice labs are available here üëá',
                            link: { url: 'https://hubby.clubmed/program-lkt', label: 'LKT program' }
                        }
                    },
                    groupe: {
                        fr: {
                            message: 'Retrouve ton cercle d‚Äôapprentissage et les speakers associ√©s üëá',
                            link: { url: 'https://hubby.clubmed/groupes-lkt', label: 'Mon cercle LKT' }
                        },
                        en: {
                            message: 'Find your learning circle and the related speakers üëá',
                            link: { url: 'https://hubby.clubmed/groups-lkt', label: 'My LKT circle' }
                        }
                    },
                    activites: {
                        fr: {
                            message: 'Pour alimenter tes partages de bonnes pratiques, explore ces ateliers signatures :'
                        },
                        en: {
                            message: 'Fuel your best-practice exchanges with these signature workshops:'
                        }
                    },
                    infosPratiques: {
                        fr: {
                            message: 'Tes rep√®res pour la journ√©e :',
                            isHTML: true,
                            list: [
                                'üéì <strong>Atelier opening</strong> : 10h salle Compass.',
                                'üí° <strong>Masterclass digitale</strong> : Horizon B √† 14h.',
                                'üçπ <strong>Afterwork partage</strong> : rooftop Horizon 18h30.'
                            ]
                        },
                        en: {
                            message: 'Today‚Äôs landmarks:',
                            isHTML: true,
                            list: [
                                'üéì <strong>Workshop opening</strong>: 10 AM in Compass room.',
                                'üí° <strong>Digital masterclass</strong>: Horizon B at 2 PM.',
                                'üçπ <strong>Sharing afterwork</strong>: Horizon rooftop 6:30 PM.'
                            ]
                        }
                    }
                },
                MKT: {
                    programme: {
                        fr: {
                            message: 'Ton agenda communication & influence se trouve ici üëá',
                            link: { url: 'https://hubby.clubmed/programme-mkt', label: 'Programme MKT' }
                        },
                        en: {
                            message: 'Your communication & influence schedule lives here üëá',
                            link: { url: 'https://hubby.clubmed/program-mkt', label: 'MKT program' }
                        }
                    },
                    groupe: {
                        fr: {
                            message: 'Retrouve ton squad marketing et les influenceurs associ√©s üëá',
                            link: { url: 'https://hubby.clubmed/groupes-mkt', label: 'Mon squad MKT' }
                        },
                        en: {
                            message: 'Access your marketing squad and linked influencers üëá',
                            link: { url: 'https://hubby.clubmed/groups-mkt', label: 'My MKT squad' }
                        }
                    },
                    activites: {
                        fr: {
                            message: 'Voici les exp√©riences id√©ales pour nourrir ta strat√©gie de contenu :'
                        },
                        en: {
                            message: 'These experiences are perfect to feed your content strategy:'
                        }
                    },
                    infosPratiques: {
                        fr: {
                            message: 'Highlights du jour :',
                            isHTML: true,
                            list: [
                                'üì∏ <strong>Studio photo</strong> : ouvert 14h-17h.',
                                'üß† <strong>Workshop storytelling</strong> : 11h salle Riviera.',
                                'ü§≥ <strong>Social media lab</strong> : coaching express 16h.'
                            ]
                        },
                        en: {
                            message: 'Today‚Äôs highlights:',
                            isHTML: true,
                            list: [
                                'üì∏ <strong>Photo studio</strong>: open 2 PM - 5 PM.',
                                'üß† <strong>Storytelling workshop</strong>: 11 AM in Riviera room.',
                                'ü§≥ <strong>Social media lab</strong>: express coaching at 4 PM.'
                            ]
                        }
                    }
                },
                'MKT+': {
                    programme: {
                        fr: {
                            message: 'Ton agenda exclusif MKT+ est disponible ici üëá',
                            link: { url: 'https://hubby.clubmed/programme-mktplus', label: 'Programme MKT+' }
                        },
                        en: {
                            message: 'Your exclusive MKT+ agenda is ready here üëá',
                            link: { url: 'https://hubby.clubmed/program-mktplus', label: 'MKT+ program' }
                        }
                    },
                    groupe: {
                        fr: {
                            message: 'Voici les acc√®s VIP et ton cercle premium üëá',
                            link: { url: 'https://hubby.clubmed/groupes-mktplus', label: 'Cercle MKT+' }
                        },
                        en: {
                            message: 'Here are your VIP accesses and premium circle üëá',
                            link: { url: 'https://hubby.clubmed/groups-mktplus', label: 'MKT+ circle' }
                        }
                    },
                    activites: {
                        fr: {
                            message: 'Tes acc√®s privil√©gi√©s t‚Äôouvrent ces exp√©riences exclusives :'
                        },
                        en: {
                            message: 'Your privileged access unlocks these exclusive experiences:'
                        }
                    },
                    infosPratiques: {
                        fr: {
                            message: 'Pour profiter √† fond :',
                            isHTML: true,
                            list: [
                                'ü•Ç <strong>Salon priv√© Lagoon</strong> : ouvert d√®s 9h.',
                                'üßë‚Äçüíº <strong>Conciergerie d√©di√©e</strong> : hotline MKT+ 8h-22h.',
                                'üçΩÔ∏è <strong>D√Æner signature</strong> : 20h30 avec le Chef.'
                            ]
                        },
                        en: {
                            message: 'Make the most of it:',
                            isHTML: true,
                            list: [
                                'ü•Ç <strong>Lagoon private lounge</strong>: open from 9 AM.',
                                'üßë‚Äçüíº <strong>Dedicated concierge</strong>: MKT+ hotline 8 AM - 10 PM.',
                                'üçΩÔ∏è <strong>Signature dinner</strong>: 8:30 PM with the Chef.'
                            ]
                        }
                    }
                }
            };

            const keywordMap = {
                programme: ['programme', 'program', 'schedule', 'agenda'],
                groupe: ['groupe', 'group', 'squad', 'team'],
                activites: ['activit', 'activity', 'atelier', 'workshop'],
                clubMedLive: ['live', 'concert', 'music', 'show'],
                infosPratiques: ['info', 'pratique', 'practical', 'shuttle', 'horaire', 'schedule'],
                vivaEngage: ['viva', 'engage', 'community', 'communaut']
            };

            popChip.textContent = state.population;

            document.documentElement.lang = state.lang;

            chatInput.placeholder = translations[state.lang].placeholder;
            sendMessageBtn.textContent = translations[state.lang].send;
            backButton.setAttribute('aria-label', translations[state.lang].back);

            renderDayFilter();
            renderQuickActions();
            appendHubbyMessage(translations[state.lang].initial);

            backButton.addEventListener('click', () => {
                window.location.href = 'index.html';
            });

            langButtons.forEach((button) => {
                button.addEventListener('click', () => {
                    const selectedLang = button.dataset.lang;
                    if (state.lang === selectedLang) {
                        return;
                    }
                    state.lang = selectedLang;
                    updateLanguage();
                });
            });

            dayFilterContainer.addEventListener('click', (event) => {
                const button = event.target.closest('button[data-day]');
                if (!button) {
                    return;
                }
                const selectedDay = button.dataset.day || null;
                state.day = selectedDay === state.day ? null : selectedDay;
                renderDayFilter();
            });

            quickActionsContainer.addEventListener('click', (event) => {
                const button = event.target.closest('button[data-action]');
                if (!button) {
                    return;
                }
                const actionKey = button.dataset.action;
                const label = button.textContent.trim();
                handleUserMessage(label, actionKey);
            });

            sendMessageBtn.addEventListener('click', submitMessage);
            chatInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    submitMessage();
                }
            });

            function submitMessage() {
                const message = chatInput.value.trim();
                if (!message) {
                    return;
                }
                chatInput.value = '';
                chatInput.focus();
                handleUserMessage(message);
            }

            function handleUserMessage(message, forcedAction = null) {
                appendUserMessage(message);
                const actionKey = forcedAction || detectAction(message);
                if (actionKey) {
                    respondWithAction(actionKey);
                } else {
                    respondWithFallback();
                }
            }

            function normalizeText(text) {
                return text
                    .normalize('NFD')
                    .replace(/\p{Diacritic}/gu, '')
                    .toLowerCase();
            }

            function detectAction(message) {
                const normalized = normalizeText(message);
                for (const [action, keywords] of Object.entries(keywordMap)) {
                    if (keywords.some((keyword) => normalized.includes(keyword))) {
                        return action;
                    }
                }
                return null;
            }

            function respondWithAction(actionKey) {
                const response = getResponseContent(actionKey);
                if (!response) {
                    respondWithFallback();
                    return;
                }
                showTypingIndicator(() => {
                    appendHubbyMessage(response.message, response.isHTML);
                });
            }

            function respondWithFallback() {
                const fallback = translations[state.lang].fallback;
                showTypingIndicator(() => {
                    appendHubbyMessage(fallback);
                });
            }

            function getResponseContent(actionKey) {
                const baseEntry = responses.DEFAULT?.[actionKey];
                const populationEntry = responses[state.population]?.[actionKey];
                const entry = mergeEntries(baseEntry, populationEntry);
                if (!entry) {
                    return null;
                }
                const langContent = cloneContent(entry[state.lang]);
                if (!langContent) {
                    return null;
                }

                let message = '';
                let isHTML = Boolean(langContent?.isHTML);

                if (langContent?.days) {
                    const dayMessage = state.day ? langContent.days[state.day] : null;
                    message = dayMessage || langContent.days.default || '';
                }

                if (!message && typeof langContent === 'string') {
                    message = langContent;
                }

                if (!message && langContent?.message) {
                    message = langContent.message;
                }

                if (Array.isArray(langContent?.list) && langContent.list.length) {
                    const listMarkup = langContent.list.map((item) => `<li>${item}</li>`).join('');
                    const wrapper = `<ul class="message-list">${listMarkup}</ul>`;
                    message = message ? `${message}<br>${wrapper}` : wrapper;
                    isHTML = true;
                }

                if (langContent?.link) {
                    const link = langContent.link;
                    const linkMarkup = `<a href="${link.url}" target="_blank" rel="noopener noreferrer">${link.label || link.url}</a>`;
                    message = message ? `${message}<br>${linkMarkup}` : linkMarkup;
                    isHTML = true;
                }

                if (Array.isArray(langContent?.links) && langContent.links.length) {
                    const linksMarkup = langContent.links
                        .map((link) => `<a href="${link.url}" target="_blank" rel="noopener noreferrer">${link.label || link.url}</a>`)
                        .join('<br>');
                    message = message ? `${message}<br>${linksMarkup}` : linksMarkup;
                    isHTML = true;
                }

                if (!message) {
                    return null;
                }

                return { message, isHTML };
            }

            function mergeEntries(baseEntry, populationEntry) {
                if (!baseEntry && !populationEntry) {
                    return null;
                }
                if (!baseEntry) {
                    return cloneContent(populationEntry);
                }
                if (!populationEntry) {
                    return cloneContent(baseEntry);
                }
                const merged = {};
                for (const lang of ['fr', 'en']) {
                    if (populationEntry[lang] !== undefined) {
                        merged[lang] = mergeLanguageContent(baseEntry[lang], populationEntry[lang]);
                    } else if (baseEntry[lang] !== undefined) {
                        merged[lang] = cloneContent(baseEntry[lang]);
                    }
                }
                return merged;
            }

            function mergeLanguageContent(baseLang, overrideLang) {
                if (overrideLang === undefined || overrideLang === null) {
                    return cloneContent(baseLang);
                }
                if (typeof baseLang === 'string' && typeof overrideLang === 'string') {
                    return overrideLang;
                }
                if (typeof overrideLang === 'string') {
                    return overrideLang;
                }
                if (typeof baseLang === 'string') {
                    return cloneContent(overrideLang);
                }
                const merged = { ...cloneContent(baseLang), ...cloneContent(overrideLang) };
                if (baseLang?.list && overrideLang?.list) {
                    merged.list = overrideLang.list;
                }
                if (baseLang?.links && overrideLang?.links) {
                    merged.links = overrideLang.links;
                }
                if (baseLang?.days && overrideLang?.days) {
                    merged.days = { ...baseLang.days, ...overrideLang.days };
                }
                return merged;
            }

            function cloneContent(content) {
                if (content === undefined || content === null) {
                    return content;
                }
                if (typeof content === 'string') {
                    return content;
                }
                return JSON.parse(JSON.stringify(content));
            }

            function appendUserMessage(text) {
                appendMessage('user', text, false);
            }

            function appendHubbyMessage(text, isHTML = false) {
                appendMessage('hubby', text, isHTML);
            }

            function appendMessage(author, text, isHTML) {
                const bubble = document.createElement('div');
                bubble.className = `message ${author === 'hubby' ? 'message--hubby' : 'message--user'}`;
                const paragraph = document.createElement('div');
                paragraph.className = 'message-content';
                if (isHTML) {
                    paragraph.innerHTML = text;
                } else {
                    paragraph.textContent = text;
                }
                bubble.appendChild(paragraph);
                chatWindow.appendChild(bubble);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            function showTypingIndicator(callback) {
                const indicator = document.createElement('div');
                indicator.className = 'message message--hubby message--typing';
                indicator.setAttribute('aria-live', 'assertive');
                indicator.innerHTML = `<div class="typing-indicator">${translations[state.lang].typing}</div>`;
                chatWindow.appendChild(indicator);
                chatWindow.scrollTop = chatWindow.scrollHeight;

                window.setTimeout(() => {
                    indicator.remove();
                    callback();
                }, 900);
            }

            function renderQuickActions() {
                quickActionsContainer.innerHTML = '';
                const keys = quickActionsByPopulation[state.population] || quickActionsByPopulation.DEFAULT;
                keys.forEach((key) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.dataset.action = key;
                    button.className = 'quick-action-btn';
                    button.textContent = translations[state.lang].quickActions[key] || key;
                    quickActionsContainer.appendChild(button);
                });
            }

            function renderDayFilter() {
                dayFilterContainer.innerHTML = '';

                const clearButton = document.createElement('button');
                clearButton.type = 'button';
                clearButton.className = `day-pill${state.day === null ? ' is-active' : ''}`;
                clearButton.dataset.day = '';
                clearButton.textContent = translations[state.lang].dayClear;
                dayFilterContainer.appendChild(clearButton);

                dayOptions.forEach((option) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.dataset.day = option.key;
                    button.className = `day-pill${state.day === option.key ? ' is-active' : ''}`;
                    button.textContent = option.label[state.lang];
                    dayFilterContainer.appendChild(button);
                });
            }

            function updateLanguage() {
                document.documentElement.lang = state.lang;
                chatInput.placeholder = translations[state.lang].placeholder;
                sendMessageBtn.textContent = translations[state.lang].send;
                backButton.setAttribute('aria-label', translations[state.lang].back);
                langButtons.forEach((button) => {
                    if (button.dataset.lang === state.lang) {
                        button.classList.add('is-active');
                    } else {
                        button.classList.remove('is-active');
                    }
                });
                renderDayFilter();
                renderQuickActions();
                appendHubbyMessage(translations[state.lang].initial);
            }
        });
    </script>
</body>
</html>
